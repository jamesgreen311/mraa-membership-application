<script>
const messagesrepo = {

}
const session = {
}

// Page level 
function getNewApplicantId() {
  google.script.run
    .withSuccessHandler(setApplicantId)
    .generateUniqueId()
}

function setApplicantId(resp) {
  const r = JSON.parse(resp)
  session.applicantid = r.applicantid
}

function applicantDetailBlock(toggle) {
  // toggle true is on/show, false is off/hide
  const applicantDetailBlock = document.getElementById("applicant-detail");
  if (toggle) {
    applicantDetailBlock.classList.remove("d-none");
  } else {
    applicantDetailBlock.classList.add("d-none");
  }
}

function uploadWaiting(toggle) {
  const uploadWaiting = document.getElementById("uploadWaiting");
  if (toggle) {
    uploadWaiting.classList.remove("d-none");
  } else {
    uploadWaiting.classList.add("d-none");
  }
}

function resetErrorMessages() {}

function resetDisplay() {}

function setCopyrightYear() {
  const year = document.getElementById("year");
  year.innerText = moment().format("YYYY");
}

function displaySupportContact(contact) {
  const supportcontact = document.getElementById("supportcontact");
  supportcontact.innerHTML = ` > <a href='mailto:${contact}'>Support Contact</a>`;
}

function setMembershipTypeMsg(e) {
  const type = this.value
  const associateMsg = document.getElementById("associateMembership")
  const exhibitingMsg = document.getElementById("exhibitingMembership")

  if (type==="associate") {
    associateMsg.classList.remove("d-none")
    exhibitingMsg.classList.add("d-none")
  } else {
    associateMsg.classList.add("d-none")
    exhibitingMsg.classList.remove("d-none")
  }
}
// PAGE LEVEL

// I/O Methods
// App settings
/* function fetchAppSettings() {
  google.script.run.withSuccessHandler(processAppSettings).getAppSettings();
} */

function processAppSettings(resp) {
  const r = JSON.parse(resp);
  appsettings.membershipChairpersonEmail = r.membershipChairpersonEmail;
  appsettings.membershipChairpersonName = r.membershipChairpersonName;
  appsettings.maxImageSize = r.maxImageSize;
  appsettings.techContact = r.techContact;
  appsettings.imageFolderId = r.imageFolderId;
}
// APP SETTINGS


function processApplication(resp) {
/* const validApplicant = resp.length > 0;
   if (validApplicant) {
    applicant.email = resp[0];
    applicant.firstname = resp[1];
    applicant.lastname = resp[2];
    applicant.phone = resp[10];
    applicant.status = resp[4];
    applicant.type = resp[12];

    applicantDetailBlock(true);
    fetchingApplicant(false);

  } else {
    applicant.email = id;
    applicant.firstname = "n/a";
    applicant.lastname = "n/a";
    applicant.phone = "n/a";
    applicant.status = "notvalid";
    applicant.type = "n/a";
  }
  displayApplicant(applicant);
  displaySupportContact(appsettings.techContact); */
}

function saveApplication(e) {
  e.preventDefault();
  uploadWaiting(true);
  const formfile = document.querySelector("#form-file");
  const formdata = new FormData(this);
  const fr = new FileReader();
  file = formfile.files[0];

  const payload = [
    ["eventid", cfe.id],
    ["eventtitle", cfe.name],
    ["firstname", applicant.firstname],
    ["lastname", applicant.lastname],
    ["email", applicant.email],
    ["phone", applicant.phone],
    ["imagefolder", cfe.imagefolderid],
    ...formdata,
  ];
  let _data = {};
  for (const [key, value] of payload) {
    _data[key] = value;
  }
  _data.filename = `${_data.lastname}-${_data.firstname}-${_data.worktitle}-${_data.medium}-${_data.width}x${_data.height}-${_data.price}`;
  _data.fileid = "";
  _data.applicant = "YES";
  _data.availability = "";
  _data.hidden = "";
  _data.fullname = applicant.firstname + " " + applicant.lastname;
  _data.timestamp = moment().format("MMMM Do YYYY, h:mm:ss a");

  fr.onload = function (e) {
    const img = {
      filename: _data.filename,
      mimetype: file.type,
      bytes: [...new Int8Array(e.target.result)],
    };
    _data.bytes = img.bytes;
    _data.mimetype = file.type;
    //upload.push(img)

    google.script.run
      .withSuccessHandler(showComplete)
      .withUserObject(this)
      .addApplicantImages(_data);
  };
  fr.readAsArrayBuffer(file);

  return _data;
}

function emailValidate() {
  const emailAddress = document.getElementById("applicant-email").value;
  const form = document.getElementById("form-applicant-info");

  if (form.checkValidity()) {
    // fetch applicant
    fetchingApplicant(true);
    fetchApplicant(emailAddress);
  } else {
    // error handling by Bootstrap
  }
}

// Start up
function loadPageElements() {
  //fetchAppSettings();
  if (!session.applicantid) {
    getNewApplicantId();
  }

  setCopyrightYear();
}

document.addEventListener("DOMContentLoaded", loadPageElements);
document.getElementById("membershipType1").addEventListener("click", setMembershipTypeMsg)
document.getElementById("membershipType2").addEventListener("click", setMembershipTypeMsg)
</script>