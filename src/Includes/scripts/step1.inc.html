<script>
const messagesrepo = {

}
const session = {
}

// Page level begin
function getNewApplicantId() {
  google.script.run
    .withSuccessHandler(setApplicantId)
    .generateUniqueId()
}

function setApplicantId(resp) {
  const r = JSON.parse(resp)
  session.applicantid = r.applicantid
}

function applicantDetailBlock(toggle) {
  // toggle true is on/show, false is off/hide
  const applicantDetailBlock = document.getElementById("applicant-detail");
  if (toggle) {
    applicantDetailBlock.classList.remove("d-none");
  } else {
    applicantDetailBlock.classList.add("d-none");
  }
}

function uploadWaiting(toggle) {
  const uploadWaiting = document.getElementById("uploadWaiting");
  if (toggle) {
    uploadWaiting.classList.remove("d-none");
  } else {
    uploadWaiting.classList.add("d-none");
  }
}

function resetErrorMessages() {}

function resetDisplay() {
  saveButtonFieldset.disabled = false
  formApplicant.reset()
}

function setCopyrightYear() {
  const year = document.getElementById("year");
  year.innerText = moment().format("YYYY");
}

function displaySupportContact(contact) {
  const supportcontact = document.getElementById("supportcontact");
  supportcontact.innerHTML = ` > <a href='mailto:${contact}'>Support Contact</a>`;
}

function setMembershipTypeMsg(e) {
  const type = this.value
  const associateMsg = document.getElementById("associateMembership")
  const exhibitingMsg = document.getElementById("exhibitingMembership")

  if (type==="associate") {
    associateMsg.classList.remove("d-none")
    exhibitingMsg.classList.add("d-none")
  } else {
    associateMsg.classList.add("d-none")
    exhibitingMsg.classList.remove("d-none")
  }
}
// PAGE LEVEL END

// I/O Methods

// APP SETTINGS

// APPLICATION PROCESS
function saveApplication(e) {
  e.preventDefault();
  uploadWaiting(true);
  saveButtonFieldset.disabled = true
  const formdata = new FormData(this);
  formdata.append("applicantId", session.applicantid)
  formdata.append("status", "Applicant")
  formdata.append("artistSignature", `${formdata.get("firstName")} ${formdata.get("lastName")}`)
  formdata.append("dateSubmitted", moment().format("MM/DD/YYYY h:mm:ss a"))
  const data = {}

  //console.log(formdata)
  for (const pair of formdata.entries()) {
    data[pair[0]] = formdata.getAll(pair[0]).toString()
  }

  //console.log(data)
  google.script.run
    .withSuccessHandler(saveComplete)
    .withFailureHandler(showError)
    .saveApplication(data)
}

function showError(e) {
  console.log(e)
}

function saveComplete() {
  uploadWaiting(false)
  resetDisplay()
}

// Start up
function loadPageElements() {
  //fetchAppSettings();
  if (!session.applicantid) {
    getNewApplicantId();
  }

  setCopyrightYear();
  setTestValues();
}

// Testing
function setTestValues() {
  emailAddress.value = "jon.tester@test.com"
  contactNumber.value = "555-111-2233"
  firstName.value = "Jon"
  lastName.value = "Tester"
  streetAddress1.value = "123 W Main St"
  city.value = "Anytown"
  state.value = "VA"
  zipCode.value = "55555"
  reasonsForInterest.value = "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua."
  artEducationBackground.value = "Urna neque viverra justo nec ultrices dui sapien."
  artAssociatedMemberships.value = "Non quam lacus suspendisse faucibus interdum posuere."
  exhibitions.value = "Amet risus nullam eget felis eget."
  socialMediaLinks.value = "Mollis nunc sed id semper."
  websites.value = "In pellentesque massa placerat duis."
}

document.addEventListener("DOMContentLoaded", loadPageElements);
document.getElementById("formApplicant").addEventListener("submit", saveApplication)
document.getElementById("membershipType1").addEventListener("click", setMembershipTypeMsg)
document.getElementById("membershipType2").addEventListener("click", setMembershipTypeMsg)
</script>